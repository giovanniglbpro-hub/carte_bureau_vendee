<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Carte des Bureaux de Vote ‚Äì Vend√©e</title>

  <!-- IMPORTANT pour le mobile -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  >

  <!-- Police moderne -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
    rel="stylesheet"
  >

  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f7;
      color: #111827;
    }

    body.dark {
      background: #0f172a;
      color: #e5e7eb;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    /* Bandeau haut */
    #topBar {
      padding: 8px 16px;
      background: radial-gradient(circle at 0% 0%, #1d4ed8, #020617);
      color: #f9fafb;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.5);
      z-index: 1000;
    }

    .topBar-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .topBar-center {
      display: flex;
      align-items: center;
      gap: 10px;
      text-align: center;
      flex: 1;
      justify-content: center;
    }

    .logo-wrap {
      background: #ffffff;
      border-radius: 999px;
      padding: 6px;
      box-shadow:
        0 0 0 2px rgba(15,23,42,0.28),
        0 6px 18px rgba(15,23,42,0.65);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #logoRN {
      height: 46px;
      width: auto;
      filter: none;
    }

    .topBar-title {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .topBar-title h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .topBar-title p {
      margin: 0;
      font-size: 12px;
      opacity: 0.9;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      font-size: 11px;
      gap: 4px;
      background: rgba(15,23,42,0.6);
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    .pill-button {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.7);
      color: #e5e7eb;
      padding: 5px 12px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
      white-space: nowrap;
    }

    .pill-button:hover {
      background: rgba(30,64,175,0.9);
      box-shadow: 0 2px 6px rgba(15,23,42,0.4);
    }

    .pill-button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    #modeBtn {
      font-weight: 500;
    }

    /* Barre de contr√¥les */
    #menu {
      width: 100%;
      padding: 6px 16px 6px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      z-index: 900;
    }

    /* Bouton options mobile */
    .mobile-only {
      display: none;
    }

    #mobileToggle {
      align-self: center;
      background: #111827;
      border-color: rgba(148,163,184,0.9);
    }

    body.mobile-mode .mobile-only {
      display: inline-flex;
    }

    #menuWrapper {
      width: 100%;
      display: flex;
      justify-content: center;
      transition: max-height 0.25s ease, opacity 0.2s ease;
      overflow: hidden;
    }

    /* Panneau repli√© en mobile */
    body.mobile-mode:not(.mobile-options-open) #menuWrapper {
      max-height: 0;
      opacity: 0;
      pointer-events: none;
    }
    body.mobile-mode.mobile-options-open #menuWrapper {
      max-height: 400px;
      opacity: 1;
    }

    #menuInner {
      max-width: 1200px;
      width: 100%;
      background: #ffffff;
      border-radius: 12px;
      padding: 8px 12px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.10);
      display: flex;
      flex-wrap: wrap;
      gap: 6px 16px;
      align-items: center;
      font-size: 13px;
    }

    body.dark #menuInner {
      background: #020617;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.55);
      border: 1px solid #1f2937;
    }

    #menu label {
      margin-right: 4px;
      font-weight: 500;
      color: #111827;
    }
    body.dark #menu label {
      color: #e5e7eb;
    }

    .group {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    select,
    input[type="range"],
    input[type="color"],
    input[type="text"],
    button {
      font-family: inherit;
    }

    select,
    input[type="text"] {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 4px 9px;
      font-size: 12px;
      background: #f9fafb;
      outline: none;
      min-height: 26px;
    }

    body.dark select,
    body.dark input[type="text"] {
      background: #020617;
      border-color: #4b5563;
      color: #e5e7eb;
    }

    select:focus,
    input[type="text"]:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
    }

    input[type="range"] {
      accent-color: #2563eb;
    }

    input[type="color"] {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 0;
      width: 34px;
      height: 22px;
      background: #f9fafb;
    }

    .btn-small {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      padding: 4px 9px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
      white-space: nowrap;
    }

    .btn-small:hover {
      background: #e5f0ff;
      box-shadow: 0 1px 4px rgba(148, 163, 184, 0.7);
    }

    .btn-small:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    body.dark .btn-small {
      background: #020617;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    body.dark .btn-small:hover {
      background: #111827;
    }

    #searchStatus {
      font-size: 11px;
      color: #6b7280;
      margin-left: 4px;
    }

    body.dark #searchStatus {
      color: #9ca3af;
    }

    #communeLabel {
      font-weight: 600;
      font-size: 13px;
    }

    /* Carte + bas */
    #map {
      flex: 1;
      width: 100%;
      margin-top: 4px;
    }

    #infoBV {
      width: 100%;
      padding: 8px 18px;
      box-sizing: border-box;
      font-size: 13px;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      box-shadow: 0 -4px 10px rgba(15, 23, 42, 0.05);
    }

    body.dark #infoBV {
      background: #020617;
      border-top-color: #1f2937;
      color: #e5e7eb;
      box-shadow: 0 -4px 14px rgba(15, 23, 42, 0.85);
    }

    /* L√©gende */
    #legend {
      position: fixed;
      right: 12px;
      bottom: 12px;
      background: rgba(255, 255, 255, 0.95);
      padding: 6px 9px;
      border-radius: 10px;
      font-size: 11px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.18);
    }

    body.dark #legend {
      background: rgba(15, 23, 42, 0.96);
      border-color: #374151;
      color: #e5e7eb;
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.9);
    }

    #legend div {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 3px;
    }

    .leg-box {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      border: 1px solid #9ca3af;
      box-sizing: border-box;
    }

    body.dark .leg-box {
      border-color: #e5e7eb;
    }

    /* Mode mobile : interface plus grande mais panneau repliable */
    body.mobile-mode #menuInner {
      font-size: 14px;
      padding: 10px 10px;
    }

    body.mobile-mode select,
    body.mobile-mode input[type="text"] {
      min-height: 34px;
      font-size: 14px;
      padding: 6px 10px;
    }

    body.mobile-mode .btn-small {
      font-size: 14px;
      padding: 7px 12px;
    }

    body.mobile-mode #map {
      margin-top: 0;
    }

    body.mobile-mode .desktop-only {
      display: none !important;
    }

    /* Adaptation bandeau en mobile */
    body.mobile-mode #topBar {
      padding: 6px 10px;
    }
    body.mobile-mode #logoRN {
      height: 34px;
    }
    body.mobile-mode .topBar-title h1 {
      font-size: 16px;
    }
    body.mobile-mode .topBar-title p {
      display: none; /* on garde juste le titre sur petit √©cran */
    }

    @media (max-width: 768px) {
      .topBar-inner {
        gap: 8px;
      }
    }
  </style>
</head>

<body>

  <!-- Bandeau haut -->
  <div id="topBar">
    <div class="topBar-inner">
      <div class="topBar-left">
        <span class="badge">
          <span class="badge-dot"></span>
          Vend√©e ‚Äì Bureaux de vote
        </span>
      </div>

      <div class="topBar-center">
        <div class="logo-wrap">
          <img id="logoRN" src="logorn.png" alt="Logo RN">
        </div>
        <div class="topBar-title">
          <h1>Cartographie des bureaux de vote</h1>
          <p>Outil interne de visualisation & rep√©rage</p>
        </div>
      </div>

      <div class="topBar-right">
        <button id="modeBtn" class="pill-button">
          üì± Mode mobile
        </button>
      </div>
    </div>
  </div>

  <!-- Barre de contr√¥les -->
  <div id="menu">
    <!-- Bouton visible uniquement en mobile -->
    <button id="mobileToggle" class="pill-button mobile-only">
      üéõÔ∏è Options carte
    </button>

    <div id="menuWrapper">
      <div id="menuInner">
        <!-- Commune -->
        <div class="group">
          <label for="selectCommune">Commune :</label>
          <select id="selectCommune">
            <option value="">-- Toutes --</option>
          </select>
        </div>

        <!-- Bureau -->
        <div class="group">
          <label for="selectBV">Bureau :</label>
          <select id="selectBV">
            <option value="">-- Choisir --</option>
          </select>
        </div>

        <!-- Opacit√© autres bureaux de la commune -->
        <div class="group desktop-only">
          <label for="othersOpacity">Autres bureaux :</label>
          <input id="othersOpacity" type="range" min="0" max="100" value="40">
          <span id="othersOpacityVal">40%</span>
        </div>

        <!-- Couleurs -->
        <div class="group desktop-only">
          <label for="bureauColor">Couleur bureau :</label>
          <input id="bureauColor" type="color" value="#ff0000">
        </div>

        <div class="group desktop-only">
          <label for="maskColor">Couleur fond :</label>
          <input id="maskColor" type="color" value="#888888">
        </div>

        <!-- Fond de carte -->
        <div class="group desktop-only">
          <label for="basemapSelect">Fond :</label>
          <select id="basemapSelect">
            <option value="osm">OSM</option>
            <option value="light">Clair</option>
            <option value="dark">Nuit</option>
          </select>
        </div>

        <!-- Export / Reset -->
        <div class="group">
          <button id="exportBtn" class="btn-small">üì∑ Exporter PNG</button>
          <button id="resetBtn" class="btn-small">‚Ü∫ R√©initialiser</button>
        </div>

        <!-- Commune choisie -->
        <div class="group" style="flex: 1 1 100%; justify-content: center;">
          <span id="communeLabel">Commune choisie : Toutes communes</span>
        </div>

        <!-- Recherche / localisation -->
        <div class="group" style="flex: 1 1 100%; margin-top: 4px;">
          <label for="searchInput">Adresse :</label>
          <input id="searchInput" type="text" style="flex:1; min-width: 200px;" placeholder="Ex : 10 Rue x, Les Sables-d‚ÄôOlonne">
          <button id="searchBtn" class="btn-small">üîé Rechercher</button>
          <button id="locateBtn" class="btn-small">üìç Me localiser</button>
          <label for="radiusSelect" class="desktop-only">Rayon :</label>
          <select id="radiusSelect" class="desktop-only">
            <option value="0">Aucun</option>
            <option value="200">200 m</option>
            <option value="500" selected>500 m</option>
            <option value="1000">1 km</option>
          </select>
          <span id="searchStatus"></span>
        </div>

        <!-- Favoris / Historique / Aide -->
        <div class="group desktop-only" style="flex: 1 1 100%; margin-top: 4px;">
          <button id="favAddBtn" class="btn-small">‚≠ê Ajouter aux favoris</button>
          <button id="favClearBtn" class="btn-small">üóë Favoris</button>
          <label for="favSelect">Favoris :</label>
          <select id="favSelect">
            <option value="">-- Aucun --</option>
          </select>

          <button id="histClearBtn" class="btn-small">üóë Hist.</button>
          <label for="historySelect">Historique :</label>
          <select id="historySelect">
            <option value="">-- Vide --</option>
          </select>

          <button id="copyLinkBtn" class="btn-small">üîó Copier lien</button>
          <button id="helpBtn" class="btn-small">‚ùî Aide</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Carte -->
  <div id="map"></div>

  <!-- Info bureau -->
  <div id="infoBV">
    Bureau : aucun s√©lectionn√©.
  </div>

  <!-- L√©gende -->
  <div id="legend">
    <div><span class="leg-box" style="background: transparent;"></span> Bureau s√©lectionn√© (contour couleur)</div>
    <div><span class="leg-box" style="background: #aaaaaa;"></span> Autres bureaux de la commune</div>
    <div><span class="leg-box" style="background: #000000;"></span> Autres communes</div>
  </div>

  <!-- JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="script.js"></script>

</body>
</html>
